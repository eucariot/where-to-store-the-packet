Shallow vs Deep Buffers
=======================

| Буферы - это то место, где пакеты можно похранить, вкачав в них смертельную порцию задержки.
| Как сказали в `видео Packet Pushers <https://www.youtube.com/watch?v=Ti3t9OAZL3g>`_ - буферы - это религия. Хотя, скорее всего, неортодоксальная, а возможно даже секта.

Чуть позже мы поговорим о том, что такое хорошо, а что такое плохо. А пока посмотрим на реализации. 

**Shallow** - неглубокие - это буферы размером до 100МБ. Обычно это встроенная в кристалл **on-chip** память - **OCB** - On-Chip Buffer.
**Deep** - счёт уже идёт на гигабайты. Обычно **off-chip** и подключается к чипу по отдельной шине.
И нет ничего посередине.

| За последние лет десять производительность чипов выросла на порядки, трафика они теперь перемалывают терабиты в секунду вместо единиц гигабит. А размер памяти не то что не поспевает за этим ростом, он фактически почти стоит на месте. 
| Давайте грубо прикинем: если для гигабитного порта буфер размером 16 мегабайт мог абсорбировать всплеск трафика длительностью примерно 100 мс, то для 100Гб/с - всего лишь 1мс. И это только один порт, фактически же плотность портов тоже растёт и максимальная комплектация для одночипового устройства сегодня - 64 порта 400Гб/с - или 25,6 Тб/с полосы пропускания. 
| Используя только 64 МБ буфер, такой чип сможет хранить трафик 0.000005 c или 5 мкс.

Такие буферы порой даже называют `Extremely shallow buffers <https://conferences.sigcomm.org/events/apnet2017/papers/bcc-bai.pdf>`_. 

| Их воистину миниатюрный объём обусловлен в первую очередь тем, что они в прямом смысле встроены в чип. Такая память является составной частью микросхемы, и каждый дополнительный мегабайт, разумеется, будет обходиться в лишнюю тысячу долларов, больший размер и тепловыделение. Для справки Broadcom Trident 4 содержит 21 миллиард транзисторов, изготовленных по 7нм техпроцессу (это меньше размера капсида любого существующего вируса) на нескольких квадратных сантиметрах.
| Логично вытекающим следствием является скорость работы с этой памятью - она должна соответствовать производительности чипа.

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/trident4_memory.png           
           :width: 400
           :align: center

Очевидно, что не для всех задач такие маленькие буферы подходят. В частности модульные коробки с VOQ явно не могут позволить себе дробить 64 Мб на несколько тысяч очередей (*на самом деле могут*).

| Поэтому рынок предлагает решения с большой внешней памятью (Deep Buffers), размер которой начинается от 1ГБ (обычно от 4ГБ).
| Согласно `этой таблице <https://people.ucsc.edu/~warner/buffer.html>`_ существуют коммутаторы (Arista 7280QR-C48) с фантастическими 32-хгигабайтовыми буферами - это уже все сезоны Рика и Морти в неплохом качестве. Но это уже история про | VOQ - всё-таки это память не одного чипа. На моём первом ПК такого объёма был жёсткий диск. 

| Как такая память реализована зависит уже от чипа и коробки.
| Например, Broadcom **Jericho+** сгружает пакеты во внешнюю память в размере 4ГБ. Это обычная широко известная **GDDR5**, использующаяся в видеокартах.

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/jericho_deep_beffers.png           
           :width: 500
           :align: center

           ..

           `Источник <https://xrdocs.io/ncs5500/blogs/2018-05-07-ncs-5500-buffering-architecture/>`_

**Jericho2** несёт на борту новейшую память **HBM2** - High Bandwidth Memory - размером 8ГБ.

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/jericho2_deep_beffers.png           
           :width: 400
           :align: center

           ..

           `Источник <https://www.broadcom.com/products/ethernet-connectivity/switching/stratadnx/bcm88690>`_

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/chipset_die.png           
           :width: 800
           :align: center

А вот и фото Jericho2:
    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/hbm_photo.png           
           :width: 400
           :align: center

           ..

           `Источник <https://people.ucsc.edu/~warner/Bufs/CSG-DNX-Switching-J2%20Feb%2016%202018.pdf>`_

Juniper PTX и QFX10000 используют чип **Q5** собственного производства с внешней памятью - **HMC** - Hybrid Memory Cube - в размере 4ГБ.

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/juniper_hmc.png           
           :width: 500
           :align: center

           ..

           `Источник <https://forums.juniper.net/t5/Enterprise-Cloud-and/Not-all-deep-buffer-switches-are-created-equal/ba-p/318393>`_

А вот так выглядит сетевой процессор Cisco с внешней памятью:

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/cisco_npu.jpg           
           :width: 400
           :align: center

           ..

           `Источник <https://servernews.ru/958639>`_

| Перечислять можно и дальше.
| Что здесь важно отметить, что внешняя память тоже не даётся бесплатно. Во-первых, цена таких решений значительно выше. Во-вторых, пропускная способность обычно ниже. И основное ограничение - канал между чипом коммутации и чипом памяти. Для производимых массово чипов, вроде GDDR5 полоса не превышает 900ГБ в режиме half-duplex. Но это чип, явно не заточенный под задачи сетевых сервисов.

Кастомный джуниперовский HMC `обещает <https://forums.juniper.net/t5/Enterprise-Cloud-and/Not-all-deep-buffer-switches-are-created-equal/ba-p/318393>`_ 1,25 Тб/с в обоих направлениях.

Если верить `вики <https://en.wikipedia.org/wiki/High_Bandwidth_Memory#HBM2>`_, то HBM 2-го поколения, используемый в последнем чипе Broadcom Jericho2, выдаёт порядка 2Тб/с.

Но это всё ещё далеко от реальной производительности сетевого ASIC. Фактически шины до этой внешней памяти является узким местом, которое и определяет производительность чипа.

    | Когда-то мир был лучше и было строгое разделение - Shallow Buffer - это встроенная On Chip память, Deep Buffer - внешняя.
    | С развитием WLP ситуация начинает меняться. Память HBM становится co-packaged в один чип вместе с комутационным асиком. TSV и 3D Advanced Packaging значительно увеличивают пропускную способность. И нередко в перезентациях вендорово можно увидеть "Deep Buffer" и "On Chip" в одной фразе.
    | Тут нужно быть осторожным, поскольку шина между асиком и памятью, пусть даже они расположены рядышком на одном интерпозере под общей крышкой, всё ещё является узким местом и ограничивает максимальную пропускную способность.


.. toctree::
   :maxdepth: 1

   1_hybrid_buffering.rst
   2_true_evil.rst
