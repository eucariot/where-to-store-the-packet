Физическое устройство
=====================

Итак, для успешной коммутации пакета нужны следующие блоки: 

    * Парсер заголовков (Parser)
    * Лукап (Match): FIB/LFIB, Nexthop-группы, ARP Adjacencies, IPv6 ND Tables, ACL итд
    * Блоки преобразований (Action)
    * Блок управления памятью (TM/MMU)
    * Сборщик пакета (Deparser)
    * SerDes
    * Память для буферизации пакетов
    * Блок, реализующий MAC
    * Чип PHY
    * Физические порты/трансиверы

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/device_architecture_full.svg           
           :width: 800
           :align: center

Крупными мазками: оптический или электрический сигнал попадает на порт (**Rx**), тот его передаёт на **PHY**. Модуль PHY реализует функции физического уровня и передаёт биты на входные пины PFE, где сигнал блоками **SerDes** преобразуется в удобоваримый для чипа вид. Блок **MAC** из потока битов восстанавливает Ethernet-кадр и передаёт его **парсеру**. Парсер отделяет необходимые ему заголовки и передаёт их на анализ следующему блоку **Match/Action**. Тот их исследует и применяет нужные действия - отправить на правильный порт, на CPU, энкапсулировать, дропнуть итд. Тело пакета всё это время хранилось в **буферах**, управляемых **MMU**, и теперь пришло время **Traffic Manager'у** проводить все обряды QoS. И потом процесс раскручивается в обратную сторону. Снова **Match/Action**. Потом собрать пакет с новыми заголовками (**Deparser**), преобразовать кадр в поток битов (**MAC**), сериализовать (**SerDes**), осуществить действия физического уровня (**PHY**) и передать через выходной порт (**Tx**) в среду.

В простейшем случае вообще почти все блоки являются частью одного монолитного кристалла кремния. То есть они - продукт одного процесса печати на вафле.

Отдельные, составляющие чип компоненты, реализующие законченный набор функций, называются `IP-core <https://ru.wikipedia.org/wiki/IP-cores>`_ (не тот, что ты мог подумать, сетевой инженер!). То есть SerDes, MAC, TM - это всё отдельные IP-core. Зачастую они производятся сторонними компаниями, специализирующимися конкретно на данных компонентах, а потом встраиваются в микросхему. Особенно это касается SerDes - сложнейшей детали, в которую вендоры сетевых чипов не готовы вкладывать силы R&D. Один из крупных производителей SerDes - `Inphi <https://www.inphi.com/products/optical-phy/>`_.

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/monolitic_asic.png           
           :width: 800
           :align: center

*`Источник <http://www.trex.fi/2017/Ralf-Korschner-The-March-of-Merchant-Silicon.pdf>`_.*

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/rosetta.png           
           :width: 500
           :align: center

*Монолитный чип Rosetta. `Источник <https://fuse.wikichip.org/news/3293/inside-rosetta-the-engine-behind-crays-slingshot-exascale-era-interconnect/>`_.*

Другой распространённый вариант: в одном чипе сочетать несколько разных кристаллов с интерконнектом между ними.
Так, например, память HBM коммерческого производства выносится за пределы кристалла сетевого ASIC:

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/monolit_asic.png           
           :width: 400
           :align: center

Под крышкой одного производительного чипа могут быть собраны несколько, так называемых, менее производительных чиплетов (chiplet), которые, объединённые в фабрику, дают бо́льшую пропускную способность:

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/chiplets.png           
           :width: 400
           :align: center

Для некоторых решений рядовая практика - вообще все ресурсы выносить за пределы сетевого ASIC'а:

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/off_chip_resources.png           
           :width: 800
           :align: center

В случае Juniper, кстати, их Trio - это не один ASIC - это их набор, каждый из которого реализует свои функции.

Но как бы ни был устроен сам чип, ему нужно общаться с миром. 
И поэтому на животике у него есть несколько тысяч пинов:

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/pins.png           
           :width: 400
           :align: center

Одни пины нужны для того, чтобы подключить к чипу интерфейсы.
Другие - чтобы подключиться к внешней памяти (CAM/TCAM/RAM), если она есть.
Третьи - к фабрике коммутации, если коробка модульная.

Два пина образуют `дифференциальную пару <https://linkmeup.ru/blog/401.html#DIFFPAIRS>`_ для передачи данных в одном направлении. То есть две пары пинов нужны для полнодуплексной передачи.

Вот так оно потом выглядит в программах для проектирования (для случая на порядок более простой микросхемы):

    .. figure:: https://fs.linkmeup.ru/images/articles/buffers/designing_card.png           
           :width: 700
           :align: center

*`Источник <https://linkmeup.ru/blog/401.html>`_.*

Теперь пришло время разобраться с тем, что же такое загадочный SerDes. Нет, это не ножки на микросхеме.

.. toctree::
   :maxdepth: 1
   :caption: Содержание:
   
   1_serdes.rst
   2_phy.rst
   3_packaging.rst

Ну а потом от вещей мирских перейдём к тому, сколько кругов пакет проходит в чипе.